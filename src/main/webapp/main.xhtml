<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">

<h:head>
    <meta charset="UTF-8"/>
    <title>WebLab3</title>
    <h:outputStylesheet library="css" name="styles.css"/>
    <h:outputScript library="js" name="script.js"/>
</h:head>

<h:body>
    <header>
        <h1>Зыков Андрей Алексеевич | P3206 | вариант 273935</h1>
    </header>

    <main>
        <h:form id="main-form" class="input-form">
            <p:dialog header="Отправка отчета" styleClass="dialog" widgetVar="schedule-dialog" modal="true">

                <p:panelGrid id="dialogContent" columns="3" >
                    <p:outputLabel for="hours" value="Часы:"/>
                    <p:inputText id="hours" value="#{scheduleBean.hours}" required="true" requiredMessage="Введите часы">
                        <p:keyFilter mask="num"/>
                        <f:validateLongRange minimum="0"/>
                    </p:inputText>
                    <p:message for="hours"/>

                    <p:outputLabel for="minutes" value="Минуты:"/>
                    <p:inputText id="minutes" value="#{scheduleBean.minutes}" required="true" requiredMessage="Введите минуты">
                        <p:keyFilter mask="num"/>
                        <f:validateLongRange minimum="0" maximum="59"/>
                    </p:inputText>
                    <p:message for="minutes"/>

                    <p:outputLabel for="seconds" value="Секунды:"/>
                    <p:inputText id="seconds" value="#{scheduleBean.seconds}" required="true" requiredMessage="Введите секунды">
                        <p:keyFilter mask="num"/>
                        <f:validateLongRange minimum="0" maximum="59"/>
                    </p:inputText>
                    <p:message for="seconds"/>

                    <p:outputLabel for="email" value="Электронный адрес:"/>
                    <p:inputText id="email" value="#{scheduleBean.email}" required="true" requiredMessage="Введите адрес">
                        <f:validateRegex pattern="^[a-zA-Z0-9_!#$%&amp;’*+/=?`{|}~^.-]+@[a-zA-Z0-9.-]+$"/>
                    </p:inputText>
                    <p:message for="email"/>
                </p:panelGrid>

                <div class="dialog-panel">
                    <p:commandButton value="Сохранить"
                                     styleClass="save"
                                     action="#{scheduleBean.scheduleEmail}"
                                     process="@this dialogContent main-form:user-timezone-hidden"
                                     update="dialogContent"/>

                    <p:commandButton value="Отмена"
                                     styleClass="cancel"
                                     type="button"
                                     onclick="PF('schedule-dialog').hide()"/>
                </div>

            </p:dialog>
            <div class="container">
                <div class="top-row">
                    <div class="block">
                        <h:panelGroup styleClass="input-elements" id="input-group" layout="block">
                            <fieldset>
                                <legend>Изменение X</legend>
                                <h:inputText id="x-display" value="#{pointBean.x}" style="border:0; font-weight:bold;">
                                    <f:validator validatorId="xValidator"/>
                                    <p:ajax event="blur" process="@this" update="x-message check-button" />
                                </h:inputText>
                                <p:slider for="x-display" minValue="-5" maxValue="5" step="0.1">
                                    <p:ajax event="slideEnd" process="x-display"/>
                                </p:slider>
                                <h:message id="x-message" for="x-display" style="color: red;"/>
                            </fieldset>

                            <fieldset class="y-field">
                                <legend>Изменение Y</legend>
                                <p:inputText id="y-text" class="y-text" value="#{pointBean.y}" required="true"
                                             requiredMessage="Поле Y не может быть пустым"
                                             placeholder="Значение Y (от -3 до 3)">
                                    <f:validator validatorId="yValidator"/>
                                    <p:keyFilter mask="num"/>
                                    <p:ajax event="blur" process="@this" update="y-message check-button" />
                                </p:inputText>
                                <h:message id="y-message" for="y-text" style="color: red;"/>
                            </fieldset>

                            <fieldset>
                                <legend>Изменение R</legend>
                                <h:panelGroup id="r-buttons-group" styleClass="r-buttons" layout="block">
                                    <p:commandButton id="r-button-1" value="1" process="@this" update="main-form:r-buttons-group" oncomplete="handleRChange(1.0)" styleClass="#{pointBean.r.doubleValue() == 1.0 ? 'active-button' : ''}"><f:setPropertyActionListener target="#{pointBean.r}" value="#{1.0}"/></p:commandButton>
                                    <p:commandButton id="r-button-2" value="2" process="@this" update="main-form:r-buttons-group" oncomplete="handleRChange(2.0)" styleClass="#{pointBean.r.doubleValue() == 2.0 ? 'active-button' : ''}"><f:setPropertyActionListener target="#{pointBean.r}" value="#{2.0}"/></p:commandButton>
                                    <p:commandButton id="r-button-3" value="3" process="@this" update="main-form:r-buttons-group" oncomplete="handleRChange(3.0)" styleClass="#{pointBean.r.doubleValue() == 3.0 ? 'active-button' : ''}"><f:setPropertyActionListener target="#{pointBean.r}" value="#{3.0}"/></p:commandButton>
                                    <p:commandButton id="r-button-4" value="4" process="@this" update="main-form:r-buttons-group" oncomplete="handleRChange(4.0)" styleClass="#{pointBean.r.doubleValue() == 4.0 ? 'active-button' : ''}"><f:setPropertyActionListener target="#{pointBean.r}" value="#{4.0}"/></p:commandButton>
                                    <p:commandButton id="r-button-5" value="5" process="@this" update="main-form:r-buttons-group" oncomplete="handleRChange(5.0)" styleClass="#{pointBean.r.doubleValue() == 5.0 ? 'active-button' : ''}"><f:setPropertyActionListener target="#{pointBean.r}" value="#{5.0}"/></p:commandButton>
                                </h:panelGroup>
                            </fieldset>
                        </h:panelGroup>
                        <div class="button-panel">
                            <p:commandButton id="check-button" value="Проверить" action="#{pointBean.check}"
                                             disabled="#{pointBean.y == null}"
                                             process="input-group @this"
                                             update="history-data-storage results-table graph-panel point-renderer"
                                             oncomplete="restore()"/>

                            <p:commandButton value="Очистить таблицу"
                                             type="button"
                                             onclick="PF('confirm-dialog').show()"/>

                            <p:confirmDialog id="confirm-dialog"
                                             message="Вы уверены, что хотите очистить таблицу?"
                                             header="Очистка"
                                             severity="alert"
                                             widgetVar="confirm-dialog">
                                <p:commandButton value="Да"
                                                 action="#{historyBean.clearHistory}"
                                                 process="@this"
                                                 oncomplete="PF('confirm-dialog').hide(); restore();"
                                                 update="history-data-storage results-table graph-panel point-renderer"/>
                                <p:commandButton value="Нет"
                                                 onclick="PF('confirm-dialog').hide()"
                                                 type="button"/>
                            </p:confirmDialog>
                        </div>

                        <h:inputHidden id="user-timezone-hidden" value="#{scheduleBean.userTimeZoneId}"/>
                        <p:commandButton value="Отправить отчет"
                                             type="button"
                                             onclick="updateUserTimeZone(); PF('schedule-dialog').show();"/>

                        <p:commandButton value="Назад" action="#{navigationBean.navigateIndex}" styleClass="navigation-button"
                                             immediate="true"/>

                        <h:inputHidden id="svg-x" value="#{pointBean.x}"/>
                        <h:inputHidden id="svg-y" value="#{pointBean.y}"/>
                        <p:remoteCommand name="sendSvgPoint" action="#{pointBean.check}"
                                         update="history-data-storage results-table graph-panel point-renderer"
                                         oncomplete="restore()"
                                         process="@this svg-x svg-y"/>
                    </div>

                    <h:panelGroup id="graph-panel" layout="block" styleClass="block">
                        <svg id="image"
                             viewBox="0 0 400 400"
                             xmlns="http://www.w3.org/2000/svg"
                             data-r="#{pointBean.r}"
                             onclick="handleGraphClick(event)">
                            <line x1="25" x2="375" y1="200" y2="200" stroke="#334155"/>
                            <line x1="200" x2="200" y1="25" y2="375" stroke="#334155"/>
                            <polygon points="380,200 375,195 375, 205" fill="#334155" stroke="#334155"/>
                            <polygon points="200,20 205,25 195,25" fill="#334155" stroke="#334155"/>
                            <text x="380" y="215" fill="#334155">X</text>
                            <text x="185" y="20" fill="#334155">Y</text>

                            <rect height="75" width="150" x="50" y="200" fill-opacity="0.5" stroke="#3b82f6" fill="#3b82f6"/>
                            <polygon points="200,50 200,200 275,200" fill-opacity="0.5" stroke="#3b82f6" fill="#3b82f6"/>
                            <path d="M 200 200 L 125 200 A 75 75 0 0 1 200 125 Z" fill="#3b82f6" stroke="#3b82f6" fill-opacity="0.5"/>

                            <line x1="350" x2="350" y1="205" y2="195" stroke="#334155"/><text id="xr" x="350" y="190" fill="#334155">R</text>
                            <line x1="275" x2="275" y1="205" y2="195" stroke="#334155"/><text id="xr/2" x="275" y="190" fill="#334155">R/2</text>
                            <line x1="50" x2="50" y1="205" y2="195" stroke="#334155"/><text id="x-r" x="50" y="190" fill="#334155">-R</text>
                            <line x1="125" x2="125" y1="205" y2="195" stroke="#334155"/><text id="x-r/2" x="125" y="190" fill="#334155">-R/2</text>
                            <line x1="205" x2="195" y1="350" y2="350" stroke="#334155"/><text id="y-r" x="210" y="350" fill="#334155">-R</text>
                            <line x1="205" x2="195" y1="275" y2="275" stroke="#334155"/><text id="y-r/2" x="210" y="275" fill="#334155">-R/2</text>
                            <line x1="205" x2="195" y1="50" y2="50" stroke="#334155"/><text id="yr" x="210" y="50" fill="#334155">R</text>
                            <line x1="205" x2="195" y1="125" y2="125" stroke="#334155"/><text id="yr/2" x="210" y="125" fill="#334155">R/2</text>
                        </svg>
                    </h:panelGroup>
                </div>

                <div class="table-block">
                    <p:dataTable id="results-table" var="res" value="#{historyBean.history}" emptyMessage="Нет запросов">
                        <p:column headerText="X">
                            <h:outputText value="#{res.x}">
                                <f:convertNumber pattern="0.00"/>
                            </h:outputText>
                        </p:column>

                        <p:column headerText="Y">
                            <h:outputText value="#{res.y}">
                                <f:convertNumber pattern="0.00"/>
                            </h:outputText>
                        </p:column>

                        <p:column headerText="R">
                            <h:outputText value="#{res.r}">
                                <f:convertNumber pattern="0.00"/>
                            </h:outputText>
                        </p:column>

                        <p:column headerText="Результат">
                            <h:outputText value="#{res.result ? 'Попадание' : 'Промах'}" style="color: #{res.result ? 'green' : 'red'};" />
                        </p:column>

                        <p:column headerText="Время выполнения, мс">
                            <h:outputText value="#{res.requestTime}" />
                        </p:column>

                        <p:column headerText="Время запроса">
                            <h:outputText value="#{res.formattedLocalTime}" />
                        </p:column>
                    </p:dataTable>
                </div>
            </div>

            <p:outputPanel id="point-renderer" deferred="true">
                <h:outputScript>
                    restore();
                </h:outputScript>
            </p:outputPanel>

            <h:panelGroup id="history-data-storage" layout="block" style="display: none;"
                          styleClass="history-data-storage">
                <f:passThroughAttribute name="data-history" value="#{historyBean.historyAsJson}" />
            </h:panelGroup>

        </h:form>

    </main>

</h:body>

</html>